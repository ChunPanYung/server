---
# Bootstrap server for future ansible runs
# command: ansible-playbook --ask-pass --ask-become-pass bootstrap.yml
- hosts: all
  become: true

  pre_tasks:
    - name: update repo cache (debian based OS)
      tags: always
      apt:
        update_cache: true
      changed_when: false # not considered change when cache is updated
      when: ansible_os_family == "Debian"

    - name: update packages and remote unused ones
      tags: always
      apt:
        upgrade: safe
        autoremove: true
      when: ansible_os_family == "Debian"

- hosts: all # no sudo required for following task

  tasks:
    - name: set authorized key for user, copying it from current user
      authorized_key:
        user: server
        state: present
        key: "{{ lookup('file', lookup('env', 'HOME') + '/.ssh/id_ed25519.pub') }}"
